<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Xanalytics · Live Analytics</title>
<style>
/* =========================
   Base + Notum (default)
   ========================= */
:root{
  /* Notum Blue — high contrast */
  --bg:#0b1220;        /* page bg */
  --panel:#111a2b;     /* panels */
  --face:#152036;      /* content face */
  --ink:#d7e6ff;       /* primary text */
  --muted:#b7c6de;     /* secondary text (brighter for legibility) */
  --hi:#2a4c9b;        /* bevel hi / outlines */
  --lo:#060a14;        /* bevel low / deep bg */
  --shadow:#000;

  --ok:#40d57c; 
  --err:#ff6b6b; 
  --link:#a7c7ff;

  --xp-bg:#0f2a1e; 
  --axp-bg:#0e1f3e; 
  --sk-bg:#3a2712; 
  --rxp-bg:#2b1240;

  --xp-bar:#4ade80; 
  --axp-bar:#60a5fa; 
  --sk-bar:#fb923c;

  --btn-active-bg:#1e3256;
  --focus:#9fc3ff;
}

body.xp{
  /* Windows XP vibe, accessible */
  --bg:#cfcfcf; --panel:#e6e3df; --face:#f3f2f1; --ink:#111; --muted:#333;
  --hi:#fff; --lo:#646464; --shadow:#000;
  --ok:#148814; --err:#b10000; --link:#003db8;
  --xp-bg:#e7ffe7; --axp-bg:#e7f0ff; --sk-bg:#fff4e2; --rxp-bg:#f4e7ff;
  --xp-bar:#1ea31e; --axp-bar:#1a66d1; --sk-bar:#c27b17;
  --btn-active-bg:#d8e8ff;
}

body.monokai{
  /* Monokai nudged for contrast */
  --bg:#1e1f1c; --panel:#2a2b26; --face:#33342e; --ink:#f8f8f2; --muted:#e3e3d4;
  --hi:#49483e; --lo:#11120f; --shadow:#000;
  --ok:#a6e22e; --err:#f92672; --link:#b6f1ff;
  --xp-bg:#1a2e1a; --axp-bg:#162238; --sk-bg:#3b2912; --rxp-bg:#271339;
  --xp-bar:#a6e22e; --axp-bar:#66d9ef; --sk-bar:#fd971f;
  --btn-active-bg:#3a3b33;
  --focus:#dcdcae;
}

html,body{height:100%}
body{
  margin:0;padding:10px;background:var(--bg);color:var(--ink);
  font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  transition:background .2s,color .2s
}
a{color:var(--link);text-decoration:none}
a:hover{text-decoration:underline}
:focus{outline:2px solid var(--focus);outline-offset:2px}

/* Window + chrome */
.window{background:var(--face);box-shadow:none;border:1px solid var(--hi);border-radius:10px}
body.xp .window{box-shadow:inset -1px -1px 0 var(--lo), inset 1px 1px 0 var(--hi), inset -2px -2px 0 var(--shadow), inset 2px 2px 0 #e9e9e9;border-radius:0;border:none}
.titlebar{background:linear-gradient(90deg,#1e3a8a,#3b82f6);color:#fff;font-weight:700;padding:6px 10px;display:flex;align-items:center;gap:10px;border-radius:10px 10px 0 0}
body.xp .titlebar{background:linear-gradient(90deg,#001a66,#0b6bd6);border-radius:0}
body.monokai .titlebar{background:#242520}
.badge{background:#000;color:#fff;padding:2px 8px;border:1px solid #fff;font-weight:800;border-radius:6px}
.content{padding:10px}
.grid{display:grid;grid-template-columns:320px 1fr;gap:10px}

.group{background:var(--panel);padding:8px;box-shadow:inset -1px -1px 0 var(--lo), inset 1px 1px 0 var(--hi);margin-bottom:10px;border-radius:10px}
body.xp .group, body.monokai .group{box-shadow:none;border:1px solid var(--hi)}
.group h3{margin:0 0 6px 0;font-size:13px;font-weight:800}

.row{display:flex;align-items:center;gap:8px;margin:6px 0;flex-wrap:wrap}
.small{font-size:12px;color:var(--muted)}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}

.input, select{
  background:#fff;color:#000;border:1px solid var(--hi);
  padding:5px 7px;border-radius:8px
}
body.xp .input, body.xp select, body.monokai .input, body.monokai select{background:var(--face);color:var(--ink)}
.input.w{width:160px}

.btn{
  background:var(--face);color:var(--ink);padding:6px 10px;cursor:pointer;
  border:1px solid var(--hi);border-radius:8px
}
.btn:active{filter:brightness(0.95)}
.btn.ghost{opacity:.9}
.btn.alt{font-weight:800}

/* ===== XP theme: square edges + retro formatting ===== */
body.xp { font-family: "MS Sans Serif", Tahoma, Segoe UI, Arial, sans-serif; }
body.xp .window,
body.xp .group,
body.xp .statusbar,
body.xp .table,
body.xp .pane,
body.xp .card,
body.xp .chip,
body.xp .segment,
body.xp .btn,
body.xp .input,
body.xp select,
body.xp .drop,
body.xp .pill,
body.xp .logList,
body.xp .logItem,
body.xp .modal,
body.xp .modal .tabs button,
body.xp .modal .panel { border-radius: 0 !important; }

body.xp .btn,
body.xp .input,
body.xp select,
body.xp .drop,
body.xp .group,
body.xp .table,
body.xp .pane,
body.xp .statusbar,
body.xp .card,
body.xp .chip,
body.xp .logList,
body.xp .logItem,
body.xp .modal .panel {
  box-shadow:
    inset -1px -1px 0 var(--lo),
    inset  1px  1px 0 var(--hi),
    inset -2px -2px 0 var(--shadow),
    inset  2px  2px 0 #e9e9e9 !important;
  border: none !important;
}
body.xp :focus { outline: 1px dotted #000; outline-offset: 0; }

.drop{
  display:flex;align-items:center;justify-content:center;height:100px;text-align:center;
  background:var(--face);padding:6px;border:1px dashed var(--hi);border-radius:10px; cursor: pointer;
}
.drop.dragover{outline:2px dashed var(--link);outline-offset:4px}

.statusbar{
  display:flex;justify-content:space-between;align-items:center;gap:8px;padding:6px;
  background:var(--panel);border:1px solid var(--hi);border-radius:10px
}
.dot{width:10px;height:10px;background:#777;display:inline-block;border:1px solid #000;border-radius:50%}
.dot.ok{background:var(--ok)} .dot.err{background:var(--err)}

.table{
  background:var(--face);color:var(--ink);height:320px;overflow:auto;padding:6px;
  border:1px solid var(--hi);border-radius:10px
}
.table pre{margin:0;font-size:12px}

.panes{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.pane{
  background:var(--face);height:170px;overflow:auto;padding:6px;
  border:1px solid var(--hi);border-radius:10px
}
.pane pre{margin:0;font-size:12px}

.path{max-width:260px;overflow:hidden;text-overflow:ellipsis;display:inline-block}
kbd{border:1px solid #000;padding:0 3px;background:#fff;color:#000;border-radius:4px}
.dim{color:#6f6f6f}

.pill{display:inline-block;padding:0 6px;border:1px solid var(--hi);font-weight:700;background:var(--panel);border-radius:999px}
.pill.keep{background:#0e3c1f} .pill.discard{background:#3c0e0e}
.pill.xp{background:var(--xp-bg)} .pill.axp{background:var(--axp-bg)} .pill.sk{background:var(--sk-bg)} .pill.rxp{background:var(--rxp-bg)}

.chip{
  display:inline-flex;align-items:center;gap:8px;padding:6px 10px;background:var(--face);
  border:1px solid var(--hi);border-radius:10px
}
.kpiVal{font-weight:800}.kpiSub{font-size:12px;color:var(--muted)}

.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.meter{height:10px;background:var(--face);border:1px solid var(--hi);border-radius:8px;overflow:hidden}
.bar{height:100%;width:0%}
.bar.xp{background:var(--xp-bar)}.bar.axp{background:var(--axp-bar)}.bar.sk{background:var(--sk-bar)}

.cards{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.card{background:var(--face);border:1px solid var(--hi);padding:8px;border-radius:10px}
.card h4{margin:0 0 6px 0;font-size:12px}
.metaRow{display:flex;justify-content:space-between;font-size:12px}

.feed{background:var(--face);border:1px solid var(--hi);padding:6px;height:150px;overflow:auto;border-radius:8px}
.feed .line{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
.feed .when{color:var(--muted);margin-left:6px}

.toolbar{display:flex;gap:6px;flex-wrap:wrap}
.segment{display:inline-flex;border:1px solid var(--hi);border-radius:8px;background:var(--face)}
.segment button{border:0;background:transparent;padding:6px 10px;cursor:pointer;color:var(--ink)}
.segment button.active{background:var(--btn-active-bg)}

.styleSwitch{margin-left:auto;display:flex;align-items:center;gap:6px}
.sumline{font-size:12px;margin-top:4px;color:var(--muted)}

.logList{max-height:200px;overflow:auto;background:var(--face);border:1px solid var(--hi);padding:4px;margin-top:6px;border-radius:8px}
.logItem{padding:4px;margin:2px 0;display:flex;justify-content:space-between;align-items:center;background:var(--panel);border:1px solid var(--hi);border-radius:6px}
.logItem .info{flex:1;font-size:12px}
.logItem .info .primary{font-weight:700}
.logItem .info .secondary{color:var(--muted);font-size:11px}
.logItem .btn{margin-left:8px}

/* Left column as mega-drop target */
#leftCol.dragover { outline: 2px dashed var(--link); outline-offset: 4px; }

/* ===== Modal Instructions (XP-respectful, legible) ===== */
.modal-backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; z-index:1000;
}
.modal{
  position:fixed; top:8%; left:50%; transform:translateX(-50%);
  width:720px; max-width:96vw;
  background:var(--face); color:var(--ink);
  border:1px solid var(--hi);
  border-radius:10px;
  z-index:1001;
  display:none;
}
.modal .title{
  background:linear-gradient(90deg,#1e3a8a,#3b82f6);
  color:#fff; padding:6px 10px; font-weight:800; display:flex; justify-content:space-between; align-items:center;
}
body.xp .modal .title{ background:linear-gradient(90deg,#001a66,#0b6bd6); }
.modal .body{ display:flex; gap:8px; padding:8px; }
.modal .tabs{
  display:flex; flex-direction:column; gap:6px; min-width:200px;
}
.modal .tabs button{
  text-align:left; padding:10px; border:1px solid var(--hi); background:var(--face); cursor:pointer; border-radius:8px; color:var(--ink); font-weight:600;
}
.modal .tabs button.active{ background:var(--btn-active-bg); }
.modal .panel{
  flex:1; background:var(--panel); border:1px solid var(--hi); padding:12px; border-radius:10px; max-height:60vh; overflow:auto;
}
.modal .panel h4{ margin:0 0 10px 0; font-size:15px; color:var(--ink); }
.modal .panel p, .modal .panel li{ color:var(--ink); font-size:13px; }
.modal .panel code{ font-size:12px; word-break:break-all; background:var(--face); padding:2px 4px; border:1px solid var(--hi); border-radius:4px; display:inline-block;}
.modal .footer{ padding:8px; display:flex; justify-content:flex-end; gap:8px; }

/* XP squaring for modal already handled above */
</style>
</head>
<body class="xp">
  <div class="window">
    <div class="titlebar">
      <span class="badge">XANALYTICS</span>
      <span>Live Analytics</span>
      <div class="styleSwitch small">
        Style:
        <select id="styleSel" class="input" aria-label="Theme">
          <option value="notum">Notum Blue</option>
          <option value="xp" selected>XP</option>
          <option value="monokai">Monokai</option>
        </select>
      </div>
    </div>
    <div class="content">
      <div class="grid">
        <section id="leftCol">
          <div class="group">
            <h3>Source</h3>
            <div class="drop" id="drop" tabindex="0" aria-label="Drop log file here">
              <div>
                <div style="font-weight:800;font-size:15px">Drop <span class="mono">Log.txt</span> here</div>
                <div class="small">…or click to browse</div>
              </div>
            </div>
            <div id="fileInfo" class="small" style="display:none;margin-top:6px"></div>

            <div class="small" style="margin-top:8px;padding:6px;background:var(--panel);">
              📁 Typical path:<br>
              <code>C:\Users\[YourName]\AppData\Local\Funcom\Anarchy Online\[GUID]\Anarchy Online\Prefs\[Account]\[Character]\Chat\Windows\Window[N]\Log.txt</code>
            </div>

            <div class="toolbar" style="margin-top:6px">
              <button class="btn alt" id="btnInstructions" title="How to find and attach the log">❓ Instructions</button>
              <button class="btn" id="btnAttach" title="Browse for log file">Browse Files</button>
            </div>
            <div class="toolbar" style="margin-top:6px">
              <label><input type="checkbox" id="autoscrollChk" checked> Autoscroll</label>
              <button class="btn" id="btnReset">Reset Session</button>
            </div>
          </div>

          <div class="group">
            <h3>Filters</h3>
            <div class="row"><label><input type="checkbox" id="normalizeVisibleChk"> Renormalize % to visible</label></div>
            <div class="row"><label><input type="checkbox" id="dimDiscardedOnlyChk"> Dim 'discarded only' (0 kept)</label></div>
            <div class="row">
              <label>Rarity:</label>
              <select id="rarityFilterSel" class="input">
                <option value="all">All</option>
                <option value="common">Common+</option>
                <option value="uncommon">Uncommon+</option>
                <option value="rare">Rare+</option>
                <option value="legendary">Legendary+</option>
              </select>
            </div>
            <div class="row">
              <label>Min Events:</label>
              <input type="number" id="eventMinEventsInp" class="input" value="0" min="0" style="width:80px">
            </div>
            <div class="row">
              <label>Search:</label>
              <input type="text" id="eventSearchInp" class="input w" placeholder="name filter...">
            </div>
          </div>

          <div class="group">
            <h3>XP Tracking</h3>
            <div class="row small">
              <label><input type="checkbox" id="fxp" checked> XP</label>
              <label><input type="checkbox" id="faxp" checked> Alien XP</label>
              <label><input type="checkbox" id="fsk" checked> SK</label>
              <label><input type="checkbox" id="frxp"> Research</label>
            </div>
            <div id="xpDisplay"></div>
          </div>

          <div class="statusbar">
            <div class="small">
              <span class="dot" id="statusDot"></span>
              <span id="statusText">Idle</span>
            </div>
            <div class="small mono" id="metricsText">0 lines</div>
            <div class="small" style="margin-left:auto">
              <a href="#" id="exportCSV">Export CSV</a> · 
              <a href="#" id="exportState">Export State</a>
            </div>
          </div>
        </section>

        <section>
          <div class="group">
            <h3>Events</h3>
            <div class="toolbar">
              <div class="segment" role="tablist" aria-label="View">
                <button id="viewAll" class="active" aria-selected="true">All</button>
                <button id="viewKept">Kept</button>
                <button id="viewDiscarded">Discarded</button>
                <button id="viewDiscardedOnly">Discarded Only</button>
              </div>
              <div class="segment" role="tablist" aria-label="Sort">
                <button id="sortName">Name</button>
                <button id="sortEvents">Events</button>
                <button id="sortPercent" class="active" aria-selected="true">Percent</button>
              </div>
              <button class="btn" id="toggleSortDir" title="Toggle sort direction">↓</button>
            </div>
            <div id="eventTable" class="table" aria-live="polite"></div>
          </div>

          <div class="group">
            <h3>Recent Activity</h3>
            <div id="activityFeed" class="feed" aria-live="polite"></div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Instructions Modal -->
  <div class="modal-backdrop" id="modalBackdrop"></div>
  <div class="modal" id="instructionsModal" role="dialog" aria-modal="true" aria-labelledby="instrTitle">
    <div class="title">
      <div id="instrTitle">Xanalytics · Instructions</div>
      <button class="btn" id="modalClose" aria-label="Close">Close</button>
    </div>
    <div class="body">
      <div class="tabs" role="tablist" aria-orientation="vertical">
        <button class="active" id="tabWhere" aria-controls="panelWhere" aria-selected="true">Where are logs?</button>
        <button id="tabAttach" aria-controls="panelAttach" aria-selected="false">How to attach</button>
      </div>
      <div class="panel" id="panelWhere">
        <h4>Find your AO chat logs</h4>
        <p>Typical location (copy/paste into Explorer’s path bar):</p>
        <p><code>C:\Users\[YourName]\AppData\Local\Funcom\Anarchy Online\[GUID]\Anarchy Online\Prefs\[Account]\[Character]\Chat\Windows\Window[N]\Log.txt</code></p>
        <ol style="margin-left:18px">
          <li>Press <kbd>Windows</kbd>+<kbd>R</kbd></li>
          <li>Type <span class="mono">%localappdata%\Funcom</span> and press Enter</li>
          <li>Open <span class="mono">Anarchy Online</span> → your <span class="mono">[GUID]</span></li>
          <li>Then <span class="mono">Anarchy Online</span> → <span class="mono">Prefs</span> → your <span class="mono">[Account]</span> → <span class="mono">[Character]</span> → <span class="mono">Chat\Windows</span></li>
          <li>Pick the <span class="mono">Window[N]\Log.txt</span> you actually log to (often <span class="mono">Window6</span>)</li>
        </ol>
        <p>Tip: ensure the log window is enabled in-game so new lines are written.</p>
      </div>
      <div class="panel" id="panelAttach" hidden>
        <h4>Attach your log to Xanalytics</h4>
        <ol style="margin-left:18px">
          <li><b>Drag & drop:</b> Grab <span class="mono">Log.txt</span> from Explorer and drop it anywhere in the big “Drop Log.txt here” card (or anywhere in the left column—watch the dashed highlight).</li>
          <li><b>Click to browse:</b> Click the drop card; your browser’s file picker will open. Select <span class="mono">Log.txt</span>.</li>
          <li><b>Live tail:</b> If your browser gives us a file <em>handle</em> (supported in modern Chromium), we’ll tail new lines as the game writes them.</li>
        </ol>
        <p>Privacy: processing happens locally in your browser.</p>
      </div>
    </div>
    <div class="footer">
      <button class="btn alt" id="modalDone">Done</button>
    </div>
  </div>

<script>
(function(){
'use strict';

/* =========================
   DOM refs
   ========================= */
const drop=document.getElementById('drop');
const leftCol=document.getElementById('leftCol');
const fileInfo=document.getElementById('fileInfo');
const btnAttach=document.getElementById('btnAttach');
const autoscrollChk=document.getElementById('autoscrollChk');
const btnReset=document.getElementById('btnReset');
const exportCSV=document.getElementById('exportCSV');
const exportStateLink=document.getElementById('exportState');
const normalizeVisibleChk=document.getElementById('normalizeVisibleChk');
const dimDiscardedOnlyChk=document.getElementById('dimDiscardedOnlyChk');
const rarityFilterSel=document.getElementById('rarityFilterSel');
const eventMinEventsInp=document.getElementById('eventMinEventsInp');
const eventSearchInp=document.getElementById('eventSearchInp');
const eventTable=document.getElementById('eventTable');
const activityFeed=document.getElementById('activityFeed');
const statusDot=document.getElementById('statusDot');
const statusText=document.getElementById('statusText');
const metricsText=document.getElementById('metricsText');
const viewAll=document.getElementById('viewAll');
const viewKept=document.getElementById('viewKept');
const viewDiscarded=document.getElementById('viewDiscarded');
const viewDiscardedOnly=document.getElementById('viewDiscardedOnly');
const sortName=document.getElementById('sortName');
const sortEvents=document.getElementById('sortEvents');
const sortPercent=document.getElementById('sortPercent');
const toggleSortDir=document.getElementById('toggleSortDir');
const xpDisplay=document.getElementById('xpDisplay');
const fxp=document.getElementById('fxp');
const faxp=document.getElementById('faxp');
const fsk=document.getElementById('fsk');
const frxp=document.getElementById('frxp');
const styleSel=document.getElementById('styleSel');

/* Instructions modal refs */
const btnInstructions=document.getElementById('btnInstructions');
const modal=document.getElementById('instructionsModal');
const backdrop=document.getElementById('modalBackdrop');
const modalClose=document.getElementById('modalClose');
const modalDone=document.getElementById('modalDone');
const tabWhere=document.getElementById('tabWhere');
const tabAttach=document.getElementById('tabAttach');
const panelWhere=document.getElementById('panelWhere');
const panelAttach=document.getElementById('panelAttach');

/* =========================
   State
   ========================= */
const state = {
  fileHandle: null,
  fileObj: null,
  offset: 0,
  tailTimer: null,
  reading: false,
  paused: false
};

const stats = {};
let totalKept = 0, totalDiscarded = 0;
let linesRead = 0, parseHits = 0, parseMisses = 0, rotationCount = 0, readErrors = 0;
const debugLog = [];
const rawLines = [];
let eventView = 'all';
let sortBy = 'percent';
let sortDir = 'desc';
const xpInclude = { xp: true, axp: true, sk: true, rxp: false };
const xpState = { xp: 0, axp: 0, sk: 0, rxp: 0, goals: { xp: 0, axp: 0, sk: 0 } };

/* =========================
   Modal helpers
   ========================= */
function openModal(){
  backdrop.style.display='block';
  modal.style.display='block';
  activateTab('where');
  modalClose.focus();
}
function closeModal(){
  modal.style.display='none';
  backdrop.style.display='none';
}
function activateTab(which){
  if(which==='where'){
    tabWhere.classList.add('active'); tabWhere.setAttribute('aria-selected','true');
    tabAttach.classList.remove('active'); tabAttach.setAttribute('aria-selected','false');
    panelWhere.hidden=false; panelAttach.hidden=true;
  }else{
    tabAttach.classList.add('active'); tabAttach.setAttribute('aria-selected','true');
    tabWhere.classList.remove('active'); tabWhere.setAttribute('aria-selected','false');
    panelAttach.hidden=false; panelWhere.hidden=true;
  }
}
btnInstructions.addEventListener('click', openModal);
modalClose.addEventListener('click', closeModal);
modalDone.addEventListener('click', closeModal);
backdrop.addEventListener('click', closeModal);
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
tabWhere.addEventListener('click', ()=>activateTab('where'));
tabAttach.addEventListener('click', ()=>activateTab('attach'));

/* =========================
   Core helpers
   ========================= */
function pushDebug(msg){ debugLog.push(`[${new Date().toISOString()}] ${msg}`); if (debugLog.length>100) debugLog.shift(); }
function setReading(is){ state.reading=is; statusDot.className='dot ' + (is?'ok':''); statusText.textContent=is?'Reading...':'Idle'; }
function fmt(n){ return n.toLocaleString(); }
function esc(s){ return s.replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function toNum(v){ const n=parseInt(v,10); return isNaN(n)?0:n; }
function rarityOf(p){ if(p>=10)return'Common'; if(p>=1)return'Uncommon'; if(p>=0.1)return'Rare'; return'Legendary'; }

/* =========================
   Tail: File System Access or file object
   ========================= */
async function startTailWithHandle(handle){
  resetSession(false);
  state.fileHandle=handle; state.fileObj=null;
  const file=await handle.getFile();
  fileInfo.textContent=`📁 ${file.name} (${fmt(file.size)} bytes) — Monitoring...`;
  fileInfo.style.display='block';
  pushDebug('START_TAIL_FSA: '+file.name);
  await readNewLines();
  if(state.tailTimer) clearInterval(state.tailTimer);
  state.tailTimer=setInterval(readNewLines,1000);
  setReading(true);
}

function startTailWithFile(file){
  resetSession(false);
  state.fileObj=file; state.fileHandle=null;
  fileInfo.textContent=`📁 ${file.name} (${fmt(file.size)} bytes) — One-time read`;
  fileInfo.style.display='block';
  pushDebug('START_TAIL_FILE: '+file.name);
  readNewLines();
  setReading(false);
}

async function readNewLines(){
  if(state.reading||state.paused) return;
  state.reading=true;
  try{
    let text='';
    if(state.fileHandle){
      const file=await state.fileHandle.getFile();
      if(file.size<state.offset){ rotationCount++; state.offset=0; pushDebug('FILE_ROTATION_DETECTED'); }
      if(file.size===state.offset){ state.reading=false; return; }
      const blob=file.slice(state.offset);
      const buf=await blob.arrayBuffer();
      text=new TextDecoder().decode(buf);
      state.offset=file.size;
    }else if(state.fileObj){
      // NOTE: File objects from drag-drop are snapshots; they won't grow.
      // We'll still read what's in it once.
      const blob=state.fileObj.slice(state.offset);
      const buf=await blob.arrayBuffer();
      text=new TextDecoder().decode(buf);
      state.offset+=blob.size;
    }
    if(text){
      const lines=text.split('\n');
      lines.forEach(processLine);
    }
  }catch(e){ readErrors++; pushDebug('READ_ERR: '+e); }
  state.reading=false;
}

/* =========================
   Parsing
   ========================= */
function processLine(line){
  line=line.trim(); if(!line) return;
  rawLines.push(line); if(rawLines.length>500) rawLines.shift();
  linesRead++;

  const match=line.match(/You received (.+?)\./);
  if(match){
    const itemName=match[1].trim();
    if(itemName.toLowerCase().includes('credit')){ parseMisses++; parseXPLine(line); return; }
    parseHits++;

    const isDiscarded=line.toLowerCase().includes('discarded');
    if(!stats[itemName]){
      stats[itemName]={ name:itemName, kept:0, discarded:0, high:0, low:0, minql:99999, maxql:0, sampleqls:[], lastSource:'', lastSeen:'', rarity:'' };
    }
    const stat=stats[itemName];
    if(isDiscarded){ stat.discarded++; totalDiscarded++; } else { stat.kept++; totalKept++; }
    stat.lastSeen=new Date().toISOString();

    const qlMatch=line.match(/QL\s*(\d+)/i);
    if(qlMatch){
      const ql=parseInt(qlMatch[1]);
      if(ql<stat.minql) stat.minql=ql;
      if(ql>stat.maxql) stat.maxql=ql;
      if(stat.sampleqls.length<5) stat.sampleqls.push(ql);
    }

    renderTable();
    updateMetrics();
    addActivity(itemName,isDiscarded);
  } else {
    parseMisses++;
  }

  parseXPLine(line);
}

function parseXPLine(line){
  const xpMatch=line.match(/You got ([\d,]+) XP/i);
  if(xpMatch && xpInclude.xp){ xpState.xp += parseInt(xpMatch[1].replace(/,/g,'')); refreshXPUI(); }
  const axpMatch=line.match(/You got ([\d,]+) axp/i);
  if(axpMatch && xpInclude.axp){ xpState.axp += parseInt(axpMatch[1].replace(/,/g,'')); refreshXPUI(); }
  const skMatch=line.match(/You got ([\d,]+) SK/i);
  if(skMatch && xpInclude.sk){ xpState.sk += parseInt(skMatch[1].replace(/,/g,'')); refreshXPUI(); }
  const rxpMatch=line.match(/You got ([\d,]+) research points/i);
  if(rxpMatch && xpInclude.rxp){ xpState.rxp += parseInt(rxpMatch[1].replace(/,/g,'')); refreshXPUI(); }
}

/* =========================
   XP UI
   ========================= */
function refreshXPUI(){
  let html='<div class="kpis">';
  const types=[
    { key:'xp', label:'XP', bg:'xp', show:xpInclude.xp },
    { key:'axp', label:'Alien XP', bg:'axp', show:xpInclude.axp },
    { key:'sk', label:'SK', bg:'sk', show:xpInclude.sk },
    { key:'rxp', label:'Research', bg:'rxp', show:xpInclude.rxp }
  ];
  types.forEach(t=>{
    if(!t.show) return;
    const val=xpState[t.key];
    html+=`<div class="chip">
      <div>
        <div class="kpiVal">${fmt(val)}</div>
        <div class="kpiSub">${t.label}</div>
      </div>
    </div>`;
  });
  html+='</div>';

  html+='<div style="margin-top:8px" class="small">';
  html+=`<label>XP Goal: <input type="number" id="xpGoal" value="${xpState.goals.xp}" style="width:100px" class="input"></label> `;
  html+=`<label>AXP Goal: <input type="number" id="axpGoal" value="${xpState.goals.axp}" style="width:100px" class="input"></label> `;
  html+=`<label>SK Goal: <input type="number" id="skGoal" value="${xpState.goals.sk}" style="width:100px" class="input"></label>`;
  html+='</div>';

  xpDisplay.innerHTML=html;

  const xpGoal=document.getElementById('xpGoal');
  const axpGoal=document.getElementById('axpGoal');
  const skGoal=document.getElementById('skGoal');
  if(xpGoal) xpGoal.addEventListener('change',()=>{ xpState.goals.xp=toNum(xpGoal.value); refreshXPUI(); });
  if(axpGoal) axpGoal.addEventListener('change',()=>{ xpState.goals.axp=toNum(axpGoal.value); refreshXPUI(); });
  if(skGoal) skGoal.addEventListener('change',()=>{ xpState.goals.sk=toNum(skGoal.value); refreshXPUI(); });
}
function xpReset(){ xpState.xp=xpState.axp=xpState.sk=xpState.rxp=0; refreshXPUI(); }

/* =========================
   UI updates
   ========================= */
function updateMetrics(){ metricsText.textContent=`${fmt(linesRead)} lines | ${fmt(parseHits)} hits | ${fmt(parseMisses)} misses`; }

function addActivity(itemName,isDiscarded){
  const line=document.createElement('div');
  line.className='line';
  line.innerHTML=`<span class="pill ${isDiscarded?'discard':'keep'}">${isDiscarded?'DISCARD':'KEEP'}</span> ${esc(itemName)} <span class="when">${new Date().toLocaleTimeString()}</span>`;
  activityFeed.insertBefore(line,activityFeed.firstChild);
  while(activityFeed.children.length>50) activityFeed.removeChild(activityFeed.lastChild);
  if(autoscrollChk && autoscrollChk.checked){ activityFeed.scrollTop=0; }
}

function renderTable(){
  const normalize=normalizeVisibleChk.checked;
  const dimDiscardedOnly=dimDiscardedOnlyChk.checked;
  const rarityFilter=rarityFilterSel.value;
  const minEvents=toNum(eventMinEventsInp.value);
  const search=eventSearchInp.value.toLowerCase();

  let items=Object.values(stats);

  if(eventView==='kept'){ items=items.filter(s=>s.kept>0); }
  else if(eventView==='discarded'){ items=items.filter(s=>s.discarded>0); }
  else if(eventView==='discardonly'){ items=items.filter(s=>s.discarded>0 && s.kept===0); }

  if(search){ items=items.filter(s=>s.name.toLowerCase().includes(search)); }
  if(minEvents>0){ items=items.filter(s=>(s.kept+s.discarded)>=minEvents); }

  const pctBase=normalize? items.reduce((sum,s)=>sum+s.kept+s.discarded,0) : (totalKept+totalDiscarded);

  items.forEach(s=>{
    const events=s.kept+s.discarded;
    s.percent=pctBase>0? (100.0*events)/pctBase : 0;
    s.rarity=rarityOf(s.percent);
  });

  const rarityOrder={Common:0,Uncommon:1,Rare:2,Legendary:3};
  if(rarityFilter!=='all'){
    const key=rarityFilter.charAt(0).toUpperCase()+rarityFilter.slice(1);
    const minRarity=rarityOrder[key];
    items=items.filter(s=>rarityOrder[s.rarity]>=minRarity);
  }

  if(sortBy==='name'){ items.sort((a,b)=>a.name.localeCompare(b.name)); }
  else if(sortBy==='events'){ items.sort((a,b)=>(a.kept+a.discarded)-(b.kept+b.discarded)); }
  else { items.sort((a,b)=>a.percent-b.percent); }
  if(sortDir==='desc') items.reverse();

  let html='<table style="width:100%;border-collapse:collapse;font-size:12px"><thead><tr style="background:var(--panel);position:sticky;top:0">';
  html+='<th style="text-align:left;padding:6px">Item</th>';
  html+='<th style="text-align:right;padding:6px">Events</th>';
  html+='<th style="text-align:right;padding:6px">Kept</th>';
  html+='<th style="text-align:right;padding:6px">Disc.</th>';
  html+='<th style="text-align:right;padding:6px">%</th>';
  html+='<th style="text-align:left;padding:6px">Rarity</th>';
  html+='</tr></thead><tbody>';

  items.forEach(s=>{
    const events=s.kept+s.discarded;
    const isDim=dimDiscardedOnly && s.kept===0;
    const rowStyle=isDim?'opacity:0.55':'';
    html+=`<tr style="${rowStyle}">`;
    html+=`<td style="padding:6px">${esc(s.name)}</td>`;
    html+=`<td style="text-align:right;padding:6px">${fmt(events)}</td>`;
    html+=`<td style="text-align:right;padding:6px">${fmt(s.kept)}</td>`;
    html+=`<td style="text-align:right;padding:6px">${fmt(s.discarded)}</td>`;
    html+=`<td style="text-align:right;padding:6px">${s.percent.toFixed(2)}%</td>`;
    html+=`<td style="padding:6px"><span class="pill ${s.rarity.toLowerCase()}">${s.rarity}</span></td>`;
    html+='</tr>';
  });
  html+='</tbody></table>';
  eventTable.innerHTML=html;
}

/* =========================
   Drag & Drop / Picker UX
   ========================= */
// Left column as mega drop target
['dragenter','dragover'].forEach(ev =>
  leftCol.addEventListener(ev, e => { e.preventDefault(); leftCol.classList.add('dragover'); })
);
['dragleave','drop'].forEach(ev =>
  leftCol.addEventListener(ev, () => leftCol.classList.remove('dragover'))
);

// Drop card handles files (try to get a FileSystemHandle for live tail)
drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('dragover'); });
drop.addEventListener('dragleave', () => drop.classList.remove('dragover'));
drop.addEventListener('drop', async e => {
  e.preventDefault();
  drop.classList.remove('dragover');

  try {
    const items = e.dataTransfer && e.dataTransfer.items ? Array.from(e.dataTransfer.items) : [];
    let handled = false;

    // Modern Chromium: get a file handle from the drop for live tailing
    for (const item of items) {
      if (item.kind === 'file') {
        const getHandle = item.getAsFileSystemHandle || item.webkitGetAsEntry;
        if (getHandle) {
          // New API
          if (item.getAsFileSystemHandle) {
            const handle = await item.getAsFileSystemHandle();
            if (handle && handle.kind === 'file') {
              resetSession(true);
              await startTailWithHandle(handle);
              handled = true;
              break;
            }
          } else {
            // Fallback: webkitGetAsEntry path (not live-tail capable without more work)
            const entry = item.webkitGetAsEntry();
            if (entry && entry.isFile && entry.file) {
              entry.file(file => { resetSession(true); startTailWithFile(file); });
              handled = true;
              break;
            }
          }
        }
      }
    }

    if (!handled) {
      // Old path: plain File (one-time read)
      const files = e.dataTransfer?.files;
      if (files && files.length > 0) {
        resetSession(true);
        startTailWithFile(files[0]);
      }
    }
  } catch (err) {
    pushDebug('DROP_ERR: ' + err);
    const files = e.dataTransfer?.files;
    if (files && files.length > 0) {
      resetSession(true);
      startTailWithFile(files[0]);
    }
  }
});

// Click drop area to browse (live tail if picker returns a handle)
drop.addEventListener('click', async () => {
  if ('showOpenFilePicker' in window) {
    try {
      const [handle] = await window.showOpenFilePicker({ multiple:false });
      resetSession(true);
      await startTailWithHandle(handle);
    } catch {}
  } else {
    btnAttach.click();
  }
});

btnAttach.addEventListener('click', async () => {
  if ('showOpenFilePicker' in window) {
    try {
      const [handle] = await window.showOpenFilePicker({ multiple: false });
      resetSession(true);
      await startTailWithHandle(handle);
    } catch (e) {
      if (e.name !== 'AbortError') pushDebug('PICK_ERR: ' + e);
    }
  } else {
    const input = document.createElement('input');
    input.type = 'file';
    input.addEventListener('change', () => {
      const file = input.files?.[0];
      if (file) {
        resetSession(true);
        startTailWithFile(file);
      }
    });
    input.click();
  }
});

/* =========================
   Export / Prefs / Sorting
   ========================= */
exportCSV.addEventListener('click',e=>{
  e.preventDefault();
  const normalize=normalizeVisibleChk.checked;
  let pctBase=normalize? Object.values(stats).reduce((sum,s)=>sum+s.kept+s.discarded,0) : (totalKept+totalDiscarded);
  pctBase=pctBase||1;

  const rows=[['High','Low','Name','Events','Kept','Discarded','Percent','Rarity','MinQL','MaxQL','Samples','LastSeen']];
  for(const k in stats){
    const s=stats[k];
    const events=s.kept+s.discarded;
    const pct=(100.0*events)/pctBase;
    rows.push([
      s.high||0, s.low||0, s.name, events, s.kept, s.discarded,
      pct.toFixed(2)+'%', s.rarity||rarityOf(pct),
      s.minql===99999?'':s.minql, s.maxql||'',
      (s.sampleqls||[]).join(' '), s.lastSeen||''
    ]);
  }
  const csv=rows.map(r=>r.map(c=>{
    const t=String(c??'');
    return (t.includes('"')||t.includes(',')||t.includes('\n')) ? `"${t.replace(/"/g,'""')}"` : t;
  }).join(',')).join('\n');

  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='xanalytics_session.csv'; a.click();
  URL.revokeObjectURL(url);

  const origText=exportCSV.textContent;
  exportCSV.textContent='Exported!'; exportCSV.style.color='var(--ok)';
  setTimeout(()=>{ exportCSV.textContent=origText; exportCSV.style.color=''; },2000);
});

function exportState(){
  const prefs={
    normalizeVisible: normalizeVisibleChk.checked,
    dimDiscardedOnly: dimDiscardedOnlyChk.checked,
    rarity: rarityFilterSel.value,
    sortBy, sortDir,
    search: eventSearchInp.value,
    minEvents: toNum(eventMinEventsInp.value),
    view: eventView,
    xpInclude: { ...xpInclude },
    style: styleSel.value
  };
  const events=Object.values(stats);
  const out={ when:new Date().toISOString(), totals:{ totalKept,totalDiscarded,linesRead,parseHits,parseMisses,rotationCount,readErrors }, prefs, events, xp: xpState };
  const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='xanalytics_state.json'; a.click();
  URL.revokeObjectURL(url);
}
exportStateLink.addEventListener('click',e=>{ e.preventDefault(); exportState(); });

btnReset.addEventListener('click',()=>{ if(confirm('Reset session (clear stats and XP)?')) resetSession(true); });

[normalizeVisibleChk, dimDiscardedOnlyChk, rarityFilterSel, eventMinEventsInp, eventSearchInp].forEach(el=>el.addEventListener('input',renderTable));

[viewAll, viewKept, viewDiscarded, viewDiscardedOnly].forEach(btn=>{
  btn.addEventListener('click',()=>{
    [viewAll,viewKept,viewDiscarded,viewDiscardedOnly].forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    eventView = btn===viewAll ? 'all' : btn===viewKept ? 'kept' : btn===viewDiscarded ? 'discarded' : 'discardonly';
    renderTable();
  });
});

[sortName,sortEvents,sortPercent].forEach(btn=>{
  btn.addEventListener('click',()=>{
    [sortName,sortEvents,sortPercent].forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    sortBy = btn===sortName ? 'name' : btn===sortEvents ? 'events' : 'percent';
    renderTable();
  });
});

toggleSortDir.addEventListener('click',()=>{ sortDir = (sortDir==='desc'?'asc':'desc'); toggleSortDir.textContent = (sortDir==='desc'?'↓':'↑'); renderTable(); });

[fxp,faxp,fsk,frxp].forEach(ch=>{
  ch.addEventListener('change',()=>{
    xpInclude.xp=fxp.checked; xpInclude.axp=faxp.checked; xpInclude.sk=fsk.checked; xpInclude.rxp=frxp.checked;
  });
});

styleSel.addEventListener('change',()=>{
  document.body.classList.remove('xp','monokai');
  if(styleSel.value==='xp'){ document.body.classList.add('xp'); }
  else if(styleSel.value==='monokai'){ document.body.classList.add('monokai'); }
});

/* =========================
   Reset/Init
   ========================= */
function resetSession(clearStats){
  if(state.tailTimer){ clearInterval(state.tailTimer); state.tailTimer=null; }
  state.fileHandle=null; state.fileObj=null; state.offset=0; state.reading=false; state.paused=false;
  if(clearStats){
    for(const k in stats) delete stats[k];
    totalKept=totalDiscarded=0; linesRead=parseHits=parseMisses=rotationCount=readErrors=0;
    debugLog.length=0; rawLines.length=0; xpReset();
  }
  renderTable(); updateMetrics(); fileInfo.style.display='none'; setReading(false);
}

resetSession(true);
refreshXPUI();
})();
</script>
</body>
</html>
